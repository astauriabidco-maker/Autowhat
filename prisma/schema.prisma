generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODÈLES MULTI-TENANT ---

model Tenant {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  employees Employee[]
  sites     Site[]     // Multi-sites support
  
  // === SaaS Plan & Trial ===
  plan          String    @default("TRIAL")  // TRIAL, PRO, ENTERPRISE
  status        String    @default("ACTIVE") // ACTIVE, SUSPENDED
  trialEndsAt   DateTime?                     // Date de fin d'essai
  maxEmployees  Int       @default(5)         // Limite technique
  
  // === Stripe Billing ===
  stripeCustomerId      String?   // ID Client Stripe
  stripeSubscriptionId  String?   // ID Subscription Stripe
  subscriptionStatus    String?   // active, past_due, canceled
  
  // Identification légale internationale
  country    String  @default("FR")  // Code ISO : FR, CM, US, CA
  legalName  String?                  // Raison sociale officielle
  legalId    String?                  // SIRET (FR), NIU (CM), EIN (US)
  taxId      String?                  // Numéro TVA ou équivalent
  address    String?
  city       String?
  
  // Géolocalisation par défaut du site
  defaultLatitude  Float?
  defaultLongitude Float?
  
  // Paramètres horaires pour rappels
  workStartTime String @default("09:00") // HH:MM format
  maxWorkHours  Int    @default(12)       // Seuil alerte session fantôme
  
  // Configuration sectorielle
  industry   String  @default("BTP") // Flexible - peut être personnalisé
  config     Json?   // { enableGps: true, enablePhotos: true, enableExpenses: true }
  vocabulary Json?   // { workplace: "Chantier", manager: "Chef" } - surcharges personnalisées
  
  // Langue par défaut de l'entreprise (fr, en, es)
  language   String  @default("fr")
}

// --- MODÈLE SITE (Multi-Sites) ---

model Site {
  id        String   @id @default(uuid())
  name      String   // "Paris", "Lyon", "Marseille"
  address   String?
  latitude  Float?
  longitude Float?
  radius    Int      @default(200) // Rayon de tolérance en mètres pour géofencing
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  employees Employee[]
  
  @@index([tenantId])
}

model Employee {
  id          String   @id @default(uuid())
  phoneNumber String   // Format E.164 (ex: +33612345678)
  name        String?
  role        String   @default("EMPLOYEE") // EMPLOYEE, MANAGER
  password    String?  // Hashé, uniquement pour les MANAGER
  
  // Profil de poste pour géofencing
  workProfile String   @default("MOBILE") // MOBILE = pas de restriction, SEDENTARY = doit être sur site
  
  // Leave balance (default 25 days for MVP)
  leaveBalance Int     @default(25)
  
  // Conversational state machine
  conversationState String?  // WAITING_EXPENSE_PHOTO, WAITING_EXPENSE_AMOUNT, WAITING_EXPENSE_CATEGORY
  tempExpenseData   Json?    // Temporary data during expense creation workflow
  
  // Langue des messages WhatsApp (fr, en, es)
  language   String  @default("fr")
  
  // Relation Tenant (CRITIQUE)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  // Multi-Sites: optionnel, si null = tous les sites
  siteId      String?
  site        Site?    @relation(fields: [siteId], references: [id])
  
  attendances Attendance[]
  leaves      LeaveRequest[]
  expenses    Expense[]
  documents   Document[]

  // Un numéro est unique pour un tenant donné
  @@unique([phoneNumber, tenantId])
  @@index([siteId])
}

model Attendance {
  id         String    @id @default(uuid())
  checkIn    DateTime
  checkOut   DateTime?
  status     String    @default("PRESENT")
  photoUrl   String?   // URL de la photo de pointage
  
  // Géolocalisation au pointage
  latitude       Float?
  longitude      Float?
  distanceFromSite Int?   // Distance en mètres
  locationWarning  Boolean @default(false) // true si sédentaire hors zone
  
  // Anti-spam pour rappels
  lastReminderSentAt DateTime?  // Dernière notification envoyée
  
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  
  // Dénormalisation pour sécurité (Row Level Security logicielle)
  tenantId   String
  siteId     String?   // Multi-sites filter
  
  @@index([tenantId])
  @@index([siteId])
}

model LeaveRequest {
  id         String   @id @default(uuid())
  startDate  DateTime
  endDate  DateTime
  status     String   @default("PENDING")
  
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  
  tenantId   String
}

model Expense {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  amount      Float
  category    String   // REPAS, ESSENCE, HOTEL, MATERIEL
  photoUrl    String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  tenantId    String
  siteId      String?   // Multi-sites filter
  
  @@index([tenantId])
  @@index([siteId])
}

// --- DOCUMENTS ---

model Document {
  id          String    @id @default(uuid())
  title       String    // ex: "Fiche Paie Janvier"
  category    String    // PAIE, CONTRAT, INTERNE
  url         String    // Chemin du fichier
  createdAt   DateTime  @default(now())
  
  // Si null, c'est un document global (ex: Règlement Intérieur)
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id])
  
  tenantId    String
  
  @@index([tenantId])
  @@index([employeeId])
}

// --- SUPER ADMIN (Accès global) ---

model SuperAdmin {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String   // Hashé avec bcrypt
  name        String
  createdAt   DateTime @default(now())
}

// --- NOTIFICATIONS (Alertes Manager) ---

model Notification {
  id          String   @id @default(uuid())
  managerId   String   // Le Manager destinataire (Employee avec role=MANAGER)
  type        String   // LATE, ABSENCE, GEOFENCE, EXPENSE
  title       String
  message     String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Référence optionnelle à l'employé concerné
  employeeId  String?
  
  // Isolation multi-tenant
  tenantId    String
  
  @@index([managerId])
  @@index([tenantId])
  @@index([createdAt])
}

// --- ADMIN ACTION LOGS (Traçabilité SuperAdmin) ---

model AdminActionLog {
  id            String   @id @default(uuid())
  superAdminId  String
  action        String   // IMPERSONATE, EXTEND_TRIAL, CHANGE_PLAN, SUSPEND, DELETE
  targetType    String   // TENANT, EMPLOYEE
  targetId      String
  targetName    String?
  details       String?  // JSON details (old plan, new plan, days extended, etc.)
  createdAt     DateTime @default(now())
  
  @@index([superAdminId])
  @@index([action])
  @@index([createdAt])
}

// --- MESSAGE LOGS (WhatsApp Stats) ---

model MessageLog {
  id            String   @id @default(uuid())
  tenantId      String?  // null for system messages
  employeeId    String?  // Employee involved (if any)
  direction     String   // INBOUND, OUTBOUND
  messageType   String   @default("TEXT") // TEXT, IMAGE, DOCUMENT, LOCATION
  status        String   @default("SENT") // SENT, DELIVERED, READ, FAILED
  waMessageId   String?  // WhatsApp message ID for tracking
  createdAt     DateTime @default(now())
  
  @@index([tenantId])
  @@index([direction])
  @@index([createdAt])
}

// --- PLATFORM CONFIGURATION (Single Row) ---

model PlatformConfig {
  id                 Int      @id @default(1)
  platformName       String   @default("Antigravity")
  supportEmail       String   @default("support@example.com")
  defaultTrialDays   Int      @default(14)
  maintenanceMode    Boolean  @default(false) // If true, blocks normal user login
  allowRegistrations Boolean  @default(true)  // If false, hides registration button
  updatedAt          DateTime @updatedAt
}

// --- ENCRYPTED INTEGRATIONS VAULT ---

model Integration {
  id        String   @id @default(uuid())
  provider  String   // "STRIPE", "SMTP", "WHATSAPP", "GOOGLE_MAPS"
  key       String   // "SECRET_KEY", "WEBHOOK_SECRET", "API_KEY"
  value     String   // Encrypted value (AES-256-CBC)
  isEnabled Boolean  @default(true)
  updatedAt DateTime @updatedAt

  @@unique([provider, key])
  @@index([provider])
}
