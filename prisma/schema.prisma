generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODÈLES MULTI-TENANT ---

model Tenant {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  employees Employee[]
  
  // Géolocalisation par défaut du site
  defaultLatitude  Float?
  defaultLongitude Float?
  
  // Paramètres horaires pour rappels
  workStartTime String @default("09:00") // HH:MM format
  maxWorkHours  Int    @default(12)       // Seuil alerte session fantôme
  
  // Configuration sectorielle
  industry   String  @default("BTP") // BTP, RETAIL, CLEANING, SECURITY, OFFICE
  config     Json?   // { enableGps: true, enablePhotos: true, enableExpenses: true }
  vocabulary Json?   // { workplace: "Chantier", manager: "Chef" } - surcharges personnalisées
}

model Employee {
  id          String   @id @default(uuid())
  phoneNumber String   // Format E.164 (ex: +33612345678)
  name        String?
  role        String   @default("EMPLOYEE") // EMPLOYEE, MANAGER
  password    String?  // Hashé, uniquement pour les MANAGER
  
  // Leave balance (default 25 days for MVP)
  leaveBalance Int     @default(25)
  
  // Conversational state machine
  conversationState String?  // WAITING_EXPENSE_PHOTO, WAITING_EXPENSE_AMOUNT, WAITING_EXPENSE_CATEGORY
  tempExpenseData   Json?    // Temporary data during expense creation workflow
  
  // Relation Tenant (CRITIQUE)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  attendances Attendance[]
  leaves      LeaveRequest[]
  expenses    Expense[]
  documents   Document[]

  // Un numéro est unique pour un tenant donné
  @@unique([phoneNumber, tenantId])
}

model Attendance {
  id         String    @id @default(uuid())
  checkIn    DateTime
  checkOut   DateTime?
  status     String    @default("PRESENT")
  photoUrl   String?   // URL de la photo de pointage
  
  // Géolocalisation au pointage
  latitude       Float?
  longitude      Float?
  distanceFromSite Int?   // Distance en mètres
  
  // Anti-spam pour rappels
  lastReminderSentAt DateTime?  // Dernière notification envoyée
  
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  
  // Dénormalisation pour sécurité (Row Level Security logicielle)
  tenantId   String
  
  @@index([tenantId])
}

model LeaveRequest {
  id         String   @id @default(uuid())
  startDate  DateTime
  endDate  DateTime
  status     String   @default("PENDING")
  
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  
  tenantId   String
}

model Expense {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  amount      Float
  category    String   // REPAS, ESSENCE, HOTEL, MATERIEL
  photoUrl    String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  tenantId    String
  
  @@index([tenantId])
}

// --- DOCUMENTS ---

model Document {
  id          String    @id @default(uuid())
  title       String    // ex: "Fiche Paie Janvier"
  category    String    // PAIE, CONTRAT, INTERNE
  url         String    // Chemin du fichier
  createdAt   DateTime  @default(now())
  
  // Si null, c'est un document global (ex: Règlement Intérieur)
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id])
  
  tenantId    String
  
  @@index([tenantId])
  @@index([employeeId])
}

// --- SUPER ADMIN (Accès global) ---

model SuperAdmin {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String   // Hashé avec bcrypt
  name        String
  createdAt   DateTime @default(now())
}
